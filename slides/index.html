<!DOCTYPE html>
<html>
  <head>
    <title>Making an HTTP Server - Fennel Conf 2019</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="css/main.css" type="text/css" charset="utf-8">
  </head>
  <body>
    <textarea id="source">

class: center, middle

# Making an HTTP Server in Fennel!

## Fennel Conf 2019

---

class: center, middle

# Me

I'm Calvin Rose (calsrose@bu.edu). I'm a Computer Engineering Student at 
Boston University, class of 2019, with an interest in
PL design and compilers.

I wrote the original version of Fennel with about 1000 lines of Lua in 2016, and it has grown since.

---

# My Fennel Experience
I've spent a lot of time hacking on the compiler, and less time using the language.
I wanted to make something new for Fennel Conf.

---

# Prior Art
* Fennel runs on Lua, Lua has lots of HTTP server libraries
* OpenResty, Luvit, Xavante, Lwan, moonmint, Lapis, etc.
* We could simply use the Lua bindings directly

---

# Fennel + Luvit example

* From the Luvit.io homepage

---

# Can it run on an ESP32?
* 512 kB RAM
* 4M flash
* Doesn't run Linux
* Bluetooth + WiFi peripherals

.image-50[![esp32](assets/esp32.jpg)]

---

# Solution: NodeMCU + Fennel
* NodeMCU is Lua for embedded devices
* NodeMCU runs Lua, so it runs Fennel
* Networking stack provided

---

# NodeMCU Limitation: no (useable) http
* http module says for client use only
* "Quote about not using nodeMCU for http server here."
* I do what I want.

---

# So I wrote my own HTTP parser
* HTTP is pretty simple
* Line based ASCII protocol
* We don't need to handle the whole protocol - only what our server will handle

---

# Design
* Provides a way to listen on socket, run callback when packets arrive
* packets callback &rarr; packet iterator
* packet iterator &rarr; line iterator
* line iterator &rarr; HTTP parser

---

# Implementation: The packet callback (`coroutine.yield`)
* Use coroutine.yield
* !!Show Code!!

---

# Implementation: Packet iterator &rarr; Line iterator
* In Clojure, we have lazy sequences and combinators that operate on them
* In Fennel/Lua, we can use iterators _and combinators that operate on iterators_.
* Iterators are much like lazy sequences, but can only be consumed ONCE (Linear Types?)

---

# Implementation: Line iterator combinator

<pre id='vimCodeElement'>
<span class="Comment">; Take an iterator over packets and return an iterator over lines</span>
<span class="fennelRainbow_p0">(</span><span class="Special">fn</span> <span class="Identifier">line-iter</span> <span class="fennelRainbow_p1">[</span><span class="Identifier">packets</span><span class="fennelRainbow_p1">]</span>
  <span class="fennelRainbow_p1">(</span><span class="Special">var</span> <span class="Identifier">buf</span> <span class="Constant">&quot;&quot;</span><span class="fennelRainbow_p1">)</span>
  <span class="fennelRainbow_p1">(</span><span class="Special">fn</span> <span class="Identifier">recur</span> <span class="fennelRainbow_p2">[]</span>
    <span class="fennelRainbow_p2">(</span><span class="Special">local</span> <span class="fennelRainbow_p3">(</span><span class="Identifier">residual</span> <span class="Identifier">rest</span><span class="fennelRainbow_p3">)</span> <span class="fennelRainbow_p3">(</span><span class="Special">:</span> <span class="Identifier">buf</span> <span class="Statement">:match</span> <span class="Constant">&quot;</span><span class="Constant">^([^</span>\r\n<span class="Constant">]*)</span>\r<span class="Constant">?</span>\n<span class="Constant">(.*)$</span><span class="Constant">&quot;</span><span class="fennelRainbow_p3">)</span><span class="fennelRainbow_p2">)</span>
    <span class="fennelRainbow_p2">(</span><span class="Special">if</span> <span class="Identifier">residual</span>
      <span class="fennelRainbow_p3">(</span><span class="Special">do</span> <span class="fennelRainbow_p0">(</span><span class="Special">set</span> <span class="Identifier">buf</span> <span class="Identifier">rest</span><span class="fennelRainbow_p0">)</span> <span class="Identifier">residual</span><span class="fennelRainbow_p3">)</span>
      <span class="fennelRainbow_p3">(</span><span class="Special">let</span> <span class="fennelRainbow_p0">[</span><span class="Identifier">packet</span> <span class="fennelRainbow_p1">(</span><span class="Identifier">packets</span><span class="fennelRainbow_p1">)</span><span class="fennelRainbow_p0">]</span>
        <span class="fennelRainbow_p0">(</span><span class="Special">set</span> <span class="Identifier">buf</span> <span class="fennelRainbow_p1">(</span><span class="Identifier">..</span> <span class="Identifier">buf</span> <span class="Identifier">packet</span><span class="fennelRainbow_p1">)</span><span class="fennelRainbow_p0">)</span>
        <span class="fennelRainbow_p0">(</span><span class="Identifier">recur</span><span class="fennelRainbow_p0">)</span><span class="fennelRainbow_p3">)</span><span class="fennelRainbow_p2">)</span><span class="fennelRainbow_p1">)</span><span class="fennelRainbow_p0">)</span>
</pre>

---

# Line iterator -> HTTP parser
* We can now iterate over lines and be really stupid about parsing HTTP
* Code looks like blocking code, but isn't
* Use Lua Patterns for parsing HTTP syntax line by line.
* CODE

---

# Ring-like interface
* Our http parser creates a `req` table that we pass to a handler.
* Handler needs to return a response.
* CODE

---

# Response renderer
* Covert response object to HTTP response
* send the response over HTTP
* CODE

---

# That's pretty much it
* We have an HTTP server built on a raw tcp/ip stack
* We could swap out the original packet iterator for whatever we wanted (HTTP from pipe, netcat).
* Code is small enough to work on the ESP32/NodeMCU easily.

---

# Making it better
* Some duplication, lua style things
* Duh, write some macros (I want a `loop` macro)

---

# So why make a tiny HTTP server of software?
* Prototyping
* Illustration
* Learning
* Starting point for future projects.
* Fun!
* It's probably good enough, and all code is a liability

---

# "smol software"
* Distill something to it's roots
* You won't get everything right in the first take, maybe not in the first year either.
* When performance is not paramount, code can become A LOT shorter
* Other people can play with the code
* Simple > correct
* You spend more time thinking, less time writing code

---

# These are not new ideas
* Lisp, Smalltalk, etc.
* Suckless software
* Clojure (simple made easy)

---

# Simple software can be reused in unexpected ways
* Modify server to pipe from netcat
* Reuse line-iter function
* I use this technique in the Fennel parser

---

# For software toys, sometimes the idea is more important than the code
* npm micro modules -> github gists
* A lot of the code in Fennel has been rewritten (more than once!)
* It would have been a lot harder to rewrite if the design was less flexible

---

# How smol is Fennel?
* One file, no build step, no runtime, works with most common Lua implementations.
* You can read it in an hour (a few hours?)
* But its a big file.
* It's still fun to hack on!

---

# How can the Fennel compiler be improved?
* Simplify, simplify, simplify!
* Real usage and feedback
* Document the internals! We need some internal design docs to compensate for no type system.

---

class: center, middle

# Thanks!
Questions?

    </textarea>
    <script src="js/remark.min.js" type="text/javascript"></script>
    <script>
      var slideshow = remark.create();
    </script>
  </body>
</html>
